STORY_TEXT = """
Ashley did not discover Equestria Online the way many others of her generation did.

Ashley could only barely hide her nervousness as she shut her professor's door behind her. As a research assistant, getting called in for a personal meeting was never a good thing. Either she had a new assignment, or she had done something stupid and was about to hear about it. Ashley had worked in her university's Machine Learning lab since her second year as an undergraduate, rising through the ranks until she had come to head whole projects.

“Hey, Ashley. Take a seat, I'll be right with you.”

Ashley pulled an uncomfortable chair away from the wall and perched on it like a cat about to flee. What hadn't she done right this time? Was the proof she had contributed to their upcoming Developmental Learning paper insufficiently rigorous? Had her contributions to the codebase over the last few days broken something?

Her fear faded as Professor Caul rotated around in his chair. His characteristic “you screwed up” expression was missing. New assignment, then? They talked for a few minutes about her work, about the proof, before he reached over to his desk and dropped a sheaf of paper and a rectangular box onto her lap. “I've got another paper for you.”

“Long paper.” She lifted the document, eyes jumping to the header. “MIT again? Those guys are always coming up with...” she trailed off. There was no university seal, no “Such-and-Such University Computer Science Department.” Instead, the name was “Hofvarpnir Studios,” and each page of the document was watermarked with “Proprietary Technology: This Document is for Academic Purposes Only.”

Professor Caul let her skim the paper in silence. There was a particular pattern for understanding challenging academic papers, and it didn't take long for Ashley to work through it. Well, enough to know what it was about. It took her about an hour to chew through something really dense, an hour spent highlighting and simplifying the language and connecting things until she could finally digest the academospeak.

“You're kidding me.” She set the paper down, not even looking at the object under it. “That's ridiculousness, professor. There aren't any other contributors.”

“Nope.”

“She really expects anyone to believe this? An unbounded bootstrap optimizer? That's singularity-level crap right there.”

“That's what it says.” Professor Caul grinned.

“That's nonsense.” She shook her head. “Hofvarpnir Studios, I know they're legit and everything, but– this Hanna was full of crap. I don't have to read this paper to tell you that, professor. This isn't possible. It doesn't matter how this says she did it.”

Her professor's smile widened. “I'm glad to see your other teachers haven't been neglecting your education, Ashley. When you get time to read the whole paper, I'm sure you'll only feel more confident in that conclusion. Unfortunately for you, they are apparently using this research in a public-facing product and have been for months.” He gestured at the package. “Congratulations, Ashley, you're now a verifier. Ever heard of Equestria Online?”

Talk about words she would never have expected a professor to speak. Ashley's whole body tensed, as though she had been caught with her hand in the cookie jar. She looked down, and saw what her hand was resting on. It was a brand new Ponypad, though the box had a “property of” sticker from the University. “You're young, Ashley. You like games, right?”

Ashley was still frozen. What could she say? Her brain scrambled for an answer. “I love games, professor. When I have time. I usually have to binge over summer break, before internships start.”

“That should be plenty. According to what their representatives were saying at the conference two weeks ago, this 'game' of theirs clearly shows an underlying architecture beyond anything else out there. When you've read the paper, play that game and tell me if there's any truth to what they're saying.” He sat back, expression growing a little more distant. “If there's any truth to these claims, it's time for us to find some new jobs.”

Ashley shared his laughter. “Of course, Professor.” It didn't surprise her that Caul hadn't heard much about Equestria Online. If he had heard the reviews, he probably wouldn't trust them. Caul had pictures of his two young children all over the office, along with the medals he had won from his numerous marathons. She wouldn't be surprised to learn he had never so much as picked up a video game in his life.

“Just don't have too much fun,” Caul said as she rose, opening the door to his office and holding it for her. “I'll expect a detailed report of what you find. Do everything you can to break their algorithm and see if it adapts like the paper claims it will.”

“You don't wanna play?” She stopped in the hall, holding the box back towards him. “Seems like you'd love it.”

She would've sworn she heard her professor swear under his breath. What he said was: “There's a horse on the box, Ashley. That's why I've got research assistants. Earn your keep.” The door shut with a click, leaving her alone in the hallway. Well, as alone as the top floor of the computer building ever was.

Ashley spent the rest of her work day on the paper, and found Professor Caul had been right. After understanding the algorithm, at least to the degree it was explained in the paper, she felt even more sure that it could not possibly work. Ashley ran out of time before she could open the Ponypad, which was just as well. The package was so colorful and bright she felt weird having it on her desk, as though she had robbed a small child and brought the spoils with her to work. Instead, she slipped the whole box into her backpack when it was time to get to class, and lugged it around with her until she got home that night.

It wasn’t all that heavy, but it felt like half a ton of lead on her back.

Ashley knew all about the Ponypad, and had followed the Equestria Online news with the same enthusiasm she followed all the significant developments in the game industry. She couldn’t have said if some supernatural algorithm drove the whole thing, though she wished she could’ve known. Knowing would mean she wouldn’t actually have to play.

It wasn’t that the subject matter bothered her; Ashley had been a casual fan of the show since she had read the first threads about it on /tv. It wasn't that she didn't think the game would be worth playing, just the opposite in fact. Ashley had a tendency to obsess over things: she had put nearly three hundred hours into Skyrim and twice that into Minecraft. A game as widely varied as Equestria Online might grab her and never let her go.

Over the last few months, her refusal to play had broadened the gap between herself and most members of her Brony club. She couldn't wait to see their faces this Saturday. It would be worth their smug satisfaction to be able to talk intelligently about the things they did.

At least for now though, she wasn't going to be treating the game like a regular player. Ashley's job was to figure out if it was really a learning algorithm, and not just a sophisticated game.

The rest of her homework lay forgotten as she considered the problem, sketching out a few ideas on a whiteboard she kept tacked to one wall of her dorm for that purpose. Like any algorithm, the simplest way to test it was to remove as many variables as possible.

She would have to ensure the program could learn as little as possible from her, then observe how its responses changed as she gave more. Simple enough. Ashley had the apartment to herself, one of the benefits of how many hours she worked.

For as hyped as they were, the Ponypad was a relatively simple device. Bright purple plastic, a power port, and a single USB port. There were only a few printed sheets, most of which were dedicated to the particular features of the “Engineering Model.” So the school hadn't bought this, it had come from Hofvarpnir? Maybe it would give her bragging rights at the club on Saturday. Assuming the game was half as good as everyone claimed.

Ashley resisted the temptation to try out her gaming keyboard and mouse and instead stuck with the stock accessories. Anything she did might give it more information. She had to isolate it. It was easy enough to cover up the camera with a square of electrical tape. It was a little more effort to get her Onion router into the kitchen, though most of that was digging through drawers and looking for a length of Cat-5e long enough to span the distance. She cycled through peers until she landed in South Africa. Could she do a convincing South-African accent?

What other information was she giving? The device could probably identify itself, so the algorithm would probably realize she was playing on a machine given to her university. It would know her local time, and… she could think around herself all night.

Ashley brewed herself a cup of tea, and brought it over along with some scrap paper for note taking beside the Ponypad. It was already ten, but that didn't matter. She had spent so much time thinking about the game and the algorithm and everything that she had to try it tonight, even if it was just for an hour.

“Alright, Hanna, let's see how full of shit you are.” She plugged in the cable, then fished around for the button.
"""


import pytest
from pydantic import BaseModel

from horsona.autodiff.variables import Value
from horsona.llm.base_engine import AsyncLLMEngine
from horsona.memory.gist_module import GistModule, paginate
from horsona.memory.readagent_llm import ReadAgentLLMEngine

_readagent_llm = None


@pytest.fixture
async def readagent_llm(reasoning_llm):
    global _readagent_llm

    if _readagent_llm is not None:
        return _readagent_llm

    gist_module = GistModule(reasoning_llm)
    for page in paginate(STORY_TEXT, max_chars_per_page=1500):
        await gist_module.append(Value("Story text", page))

    _readagent_llm = ReadAgentLLMEngine(reasoning_llm, gist_module, max_pages=2)
    return _readagent_llm


@pytest.mark.asyncio
async def test_query_block(readagent_llm):
    response = await readagent_llm.query_block(
        "text",
        TASK="What is Ashley supposed to do with the game?",
    )

    assert (
        "figure out" in response.lower()
        or "determine" in response.lower()
        or "test" in response.lower()
        or "verify" in response.lower()
    )


@pytest.mark.asyncio
async def test_query_object(readagent_llm):
    class Response(BaseModel):
        author: str

    response = await readagent_llm.query_object(
        Response,
        TASK="Who wrote the paper that Ashley received from her professor?",
    )

    assert isinstance(response, Response)
    assert "hanna" in response.author.lower() or "hofvarpnir" in response.author.lower()


@pytest.mark.asyncio
async def test_load_readagent_llm(reasoning_llm, readagent_llm):
    state_dict = readagent_llm.state_dict()
    restored = ReadAgentLLMEngine.load_state_dict(state_dict)

    assert isinstance(restored, ReadAgentLLMEngine)
    assert isinstance(restored.underlying_llm, type(reasoning_llm))
    assert isinstance(restored.gist_module, GistModule)
